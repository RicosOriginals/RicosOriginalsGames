<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Snake Deluxe</title>
<style>
  body {margin:0; background:#111; color:white; font-family:Arial, sans-serif; text-align:center;}
  h1 {margin:20px 0;}
  canvas {background:#222; display:block; margin:0 auto; border:3px solid #60cdee; border-radius:10px;}
  button {background:#60cdee; border:none; color:white; padding:10px 20px; margin:5px; border-radius:8px; font-size:16px; cursor:pointer;}
  #leaderboard {margin-top:15px;}
  .controls {display:flex; flex-direction:column; align-items:center; margin-top:10px;}
  .row {display:flex; gap:10px;}
  .ctrl-btn {width:60px; height:60px; font-size:24px; background:#60cdee; border:none; border-radius:50%; cursor:pointer;}
</style>
</head>
<body>

<h1>üêç Snake Deluxe</h1>
<p id="levelInfo">Level: 1</p>
<canvas id="game" width="400" height="400"></canvas>
<p id="score">Score: 0</p>
<p id="highscore">Highscore: 0</p>
<button onclick="restartGame()">üîÑ Neustart</button>
<button onclick="changeSkin()">üé® Skin wechseln</button>
<button onclick="changeName()">‚úèÔ∏è Namen √§ndern</button>
<div id="leaderboard"></div>

<!-- Mobile Controls -->
<div class="controls">
  <button class="ctrl-btn" onclick="setDir('UP')">‚¨ÜÔ∏è</button>
  <div class="row">
    <button class="ctrl-btn" onclick="setDir('LEFT')">‚¨ÖÔ∏è</button>
    <button class="ctrl-btn" onclick="setDir('DOWN')">‚¨áÔ∏è</button>
    <button class="ctrl-btn" onclick="setDir('RIGHT')">‚û°Ô∏è</button>
  </div>
</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const scoreText = document.getElementById("score");
const highscoreText = document.getElementById("highscore");
const levelInfo = document.getElementById("levelInfo");
const leaderboardDiv = document.getElementById("leaderboard");

// üî• JSONBin API f√ºr globale Bestenliste
const API_URL = "https://api.jsonbin.io/v3/b/68b05790d0ea881f40693efd "; // <--- hier Bin-ID einf√ºgen
const API_KEY = "$2a$10$cWjMtKfp3l/afQlGKk1xrePNrrFUuGXlvV2bkUYJ5nvXpXsIlM/DC"; // <--- hier Secret Key einf√ºgen

const box = 20;
let snake, direction, food, score, highscore, gameOver, level, skinIndex;
let playerName = localStorage.getItem("playerName") || prompt("Gib deinen Namen ein:") || "Player";
if(!localStorage.getItem("playerName")) localStorage.setItem("playerName", playerName);

let maps = [
  [],
  [{x:200,y:200},{x:220,y:200},{x:240,y:200}],
  [{x:100,y:100},{x:120,y:100},{x:140,y:100},{x:160,y:100}]
];
let skins = ["#60cdee", "#ffcc00", "#00ff99", "#ff3366"];

async function loadLeaderboard() {
  try {
    let res = await fetch(API_URL, { headers: { "X-Master-Key": API_KEY }});
    let data = await res.json();
    let scores = data.record.leaderboard || [];
    scores.sort((a,b)=>b.score-a.score);
    scores = scores.slice(0,10);
    let html = "<h3>üèÜ Bestenliste</h3><ol>";
    scores.forEach(s=>{ html += `<li>${s.name}: ${s.score}</li>`; });
    html += "</ol>";
    leaderboardDiv.innerHTML = html;
  } catch(e) {
    leaderboardDiv.innerHTML = "Fehler beim Laden";
    console.error(e);
  }
}

async function saveScoreGlobal() {
  try {
    let res = await fetch(API_URL, { headers: { "X-Master-Key": API_KEY }});
    let data = await res.json();
    let scores = data.record.leaderboard || [];
    scores.push({name: playerName, score});
    scores.sort((a,b)=>b.score-a.score);
    scores = scores.slice(0,10);
    await fetch(API_URL, {
      method:"PUT",
      headers:{ "X-Master-Key": API_KEY, "Content-Type":"application/json" },
      body: JSON.stringify({ leaderboard: scores })
    });
    loadLeaderboard();
  } catch(e){ console.error(e); }
}

function initGame() {
  snake = [{x:9*box, y:9*box}];
  direction="RIGHT";
  food=spawnFood();
  score=0;
  gameOver=false;
  level=level||1;
  skinIndex=skinIndex||0;
  highscore=localStorage.getItem("highscore")||0;
  highscoreText.textContent="Highscore: "+highscore;
  loadLeaderboard();
}

function spawnFood() {
  return { x: Math.floor(Math.random()*20)*box, y: Math.floor(Math.random()*20)*box };
}

document.addEventListener("keydown", e => {
  const key = e.key.toLowerCase();
  if(key==="a" && direction!=="RIGHT") direction="LEFT";
  if(key==="w" && direction!=="DOWN") direction="UP";
  if(key==="d" && direction!=="LEFT") direction="RIGHT";
  if(key==="s" && direction!=="UP") direction="DOWN";
});
function setDir(d){ 
  if(d==="LEFT" && direction!=="RIGHT") direction="LEFT";
  if(d==="RIGHT" && direction!=="LEFT") direction="RIGHT";
  if(d==="UP" && direction!=="DOWN") direction="UP";
  if(d==="DOWN" && direction!=="UP") direction="DOWN";
}

function draw() {
  ctx.fillStyle="#222";
  ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle="gray";
  for(let wall of maps[level-1]) ctx.fillRect(wall.x, wall.y, box, box);
  ctx.fillStyle="red"; ctx.fillRect(food.x,food.y,box,box);
  for(let i=0;i<snake.length;i++){
    ctx.fillStyle=i===0?skins[skinIndex]:"white";
    ctx.fillRect(snake[i].x,snake[i].y,box,box);
  }
  scoreText.textContent="Score: "+score;

  if(gameOver){
    ctx.fillStyle="red"; ctx.font="30px Arial";
    ctx.fillText("GAME OVER!",120,200);
    return;
  }

  let headX=snake[0].x, headY=snake[0].y;
  if(direction==="LEFT") headX-=box;
  if(direction==="UP") headY-=box;
  if(direction==="RIGHT") headX+=box;
  if(direction==="DOWN") headY+=box;

  if(headX===food.x && headY===food.y){
    score++;
    if(score % 10 === 0 && level < maps.length){ level++; levelInfo.textContent="Level: "+level; }
    food=spawnFood();
  } else snake.pop();

  let newHead={x:headX,y:headY};
  if(headX<0||headY<0||headX>=canvas.width||headY>=canvas.height
     ||snake.some(p=>p.x===headX && p.y===headY)
     ||maps[level-1].some(w=>w.x===headX && w.y===headY)){
    gameOver=true;
    if(score>highscore) localStorage.setItem("highscore",score);
    saveScoreGlobal();
  } else snake.unshift(newHead);
}

function restartGame(){ initGame(); }
function gameLoop(){ draw(); setTimeout(gameLoop,120); }
function changeSkin(){ skinIndex=(skinIndex+1)%skins.length; restartGame(); }
function changeName(){ 
  let newName = prompt("Neuen Namen eingeben:", playerName);
  if(newName){ playerName=newName; localStorage.setItem("playerName", playerName); }
}

initGame();
gameLoop();
</script>
</body>
</html>
